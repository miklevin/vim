#! /usr/bin/env python

import shlex
import shutil
import argparse
import pandas as pd
from os import system
from os import getuid
from sys import stdout
from art import text2art
from pwd import getpwuid
from subprocess import Popen, PIPE


# Get Linux Username for portability between systems
USERNAME = getpwuid(getuid())[0]
REPOS = f"/home/{USERNAME}/repos/"


# Set Default Number of Files to Edit
list_of_journals = f"{REPOS}hide/journal/sites.csv"
path_to_journals = f"{REPOS}hide/"
edit_first_n_journals = 3

locs = f"""
{REPOS}vim
{REPOS}skite
{REPOS}hide/Pipulate.com
""".split("\n")[1:-1]

# Use big pretty ascii art to keep user informed
fig = lambda x: print(text2art(x))
fig("Loading")

# Determine how many journals to edit at once
aparser = argparse.ArgumentParser()
add_arg = aparser.add_argument
add_arg("-n", "--number", required=False)
args = aparser.parse_args()
number = args.number
df = pd.read_csv(list_of_journals, delimiter="|")
df = df.applymap(lambda x: x.strip())
df.columns = [x.strip() for x in df.columns]
if number == None:
    df = df.head(edit_first_n_journals)
elif number.isnumeric():
    number = int(number)
    if number > df.shape[0]:
        number = df.shape[0]
    df = df.head(number)


def flush(std):
    for line in std:
        line = line.strip()
        if line:
            print(line)
            stdout.flush()


def git(cwd, args):
    cmd = ["/usr/bin/git"] + shlex.split(args)
    print(f"COMMAND: << {shlex.join(cmd)} >>")
    process = Popen(
        args=cmd,
        cwd=cwd,
        stdout=PIPE,
        stderr=PIPE,
        shell=False,
        bufsize=1,
        universal_newlines=True,
    )
    flush(process.stdout)
    flush(process.stderr)


alist = df[['path']].values.tolist()
journals = " ".join([f'{path_to_journals}{x[0]}/journal.md' for x in alist])

fig("Pulling Repos")

for loc in locs:
    fig(loc.split("/")[-1])
    git(loc, "pull")

for item in alist:
    repo = item[0]
    fig(repo)
    loc = f"{path_to_journals}{repo}"
    git(loc, 'pull')
    print()

# Add the pages from MikeLev.in that I want to edit
pre = f"{path_to_journals}MikeLev.in/" 
edit_pages = ['linux', 'python', 'vim', 'git', 'seo', 'blog', 'index']
edit_pages = [f"{pre}{x}.md" for x in edit_pages]
edit_pages = " ".join(edit_pages)

misc_files = f"""{REPOS}hide/journal/journal.txt
~/.config/nvim/init.vim
{REPOS}skite/chopchop.py
{REPOS}hide/Pipulate.com/pipulate.md
{REPOS}hide/Pipulate.com/software.md""".split("\n")
misc_files = " ".join(misc_files)

# Load everything into nvim
edit_journals = f"nvim {journals} {misc_files} {edit_pages}"
system(edit_journals)

for dotconfig in ['.screenrc', '.gitconfig', '.bash_prompt', '.bash_profile']:
    try:
        shutil.copyfile(f"/home/{USERNAME}/{dotconfig}", f"{REPOS}vim/{dotconfig}")
    except:
        pass

shutil.copyfile(f"/usr/local/sbin/all", f"{REPOS}vim/all")
try:
    shutil.copyfile(f"/home/{USERNAME}/.config/nvim/init.vim", f"{REPOS}vim/")
    shutil.copyfile(f"/home/{USERNAME}/.config/nvim/init.vim", f"/home/{USERNAME}/.vimrc")
except:
    pass

fig("Pushing Repos")

for loc in locs:
    print(loc)
    git(loc, 'commit -am "pushing vim to github..."')
    git(loc, "push")
    print()
 
for item in alist:
    repo = item[0]
    fig(repo)
    loc = f"{path_to_journals}{repo}"
    git(loc, f'commit -am "Pushing {repo} to Github..."')
    git(loc, "push")
    print()

fig("Done!")
